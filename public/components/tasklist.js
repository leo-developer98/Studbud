// Apache License
// Version 2.0, January 2004
// http://www.apache.org/licenses/

// TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION

// 1. Definitions.

// "License" shall mean the terms and conditions for use, reproduction,
// and distribution as defined by Sections 1 through 9 of this document.

// "Licensor" shall mean the copyright owner or entity authorized by
// the copyright owner that is granting the License.

// "Legal Entity" shall mean the union of the acting entity and all
// other entities that control, are controlled by, or are under common
// control with that entity. For the purposes of this definition,
// "control" means (i) the power, direct or indirect, to cause the
// direction or management of such entity, whether by contract or
// otherwise, or (ii) ownership of fifty percent (50%) or more of the
// outstanding shares, or (iii) beneficial ownership of such entity.

// "You" (or "Your") shall mean an individual or Legal Entity
// exercising permissions granted by this License.

// "Source" form shall mean the preferred form for making modifications,
// including but not limited to software source code, documentation
// source, and configuration files.

// "Object" form shall mean any form resulting from mechanical
// transformation or translation of a Source form, including but
// not limited to compiled object code, generated documentation,
// and conversions to other media types.

// "Work" shall mean the work of authorship, whether in Source or
// Object form, made available under the License, as indicated by a
// copyright notice that is included in or attached to the work
// (an example is provided in the Appendix below).

// "Derivative Works" shall mean any work, whether in Source or Object
// form, that is based on (or derived from) the Work and for which the
// editorial revisions, annotations, elaborations, or other modifications
// represent, as a whole, an original work of authorship. For the purposes
// of this License, Derivative Works shall not include works that remain
// separable from, or merely link (or bind by name) to the interfaces of,
// the Work and Derivative Works thereof.

// "Contribution" shall mean any work of authorship, including
// the original version of the Work and any modifications or additions
// to that Work or Derivative Works thereof, that is intentionally
// submitted to Licensor for inclusion in the Work by the copyright owner
// or by an individual or Legal Entity authorized to submit on behalf of
// the copyright owner. For the purposes of this definition, "submitted"
// means any form of electronic, verbal, or written communication sent
// to the Licensor or its representatives, including but not limited to
// communication on electronic mailing lists, source code control systems,
// and issue tracking systems that are managed by, or on behalf of, the
// Licensor for the purpose of discussing and improving the Work, but
// excluding communication that is conspicuously marked or otherwise
// designated in writing by the copyright owner as "Not a Contribution."

// "Contributor" shall mean Licensor and any individual or Legal Entity
// on behalf of whom a Contribution has been received by Licensor and
// subsequently incorporated within the Work.

// 2. Grant of Copyright License. Subject to the terms and conditions of
// this License, each Contributor hereby grants to You a perpetual,
// worldwide, non-exclusive, no-charge, royalty-free, irrevocable
// copyright license to reproduce, prepare Derivative Works of,
// publicly display, publicly perform, sublicense, and distribute the
// Work and such Derivative Works in Source or Object form.

// 3. Grant of Patent License. Subject to the terms and conditions of
// this License, each Contributor hereby grants to You a perpetual,
// worldwide, non-exclusive, no-charge, royalty-free, irrevocable
// (except as stated in this section) patent license to make, have made,
// use, offer to sell, sell, import, and otherwise transfer the Work,
// where such license applies only to those patent claims licensable
// by such Contributor that are necessarily infringed by their
// Contribution(s) alone or by combination of their Contribution(s)
// with the Work to which such Contribution(s) was submitted. If You
// institute patent litigation against any entity (including a
// cross-claim or counterclaim in a lawsuit) alleging that the Work
// or a Contribution incorporated within the Work constitutes direct
// or contributory patent infringement, then any patent licenses
// granted to You under this License for that Work shall terminate
// as of the date such litigation is filed.

// 4. Redistribution. You may reproduce and distribute copies of the
// Work or Derivative Works thereof in any medium, with or without
// modifications, and in Source or Object form, provided that You
// meet the following conditions:

// (a) You must give any other recipients of the Work or
// Derivative Works a copy of this License; and

// (b) You must cause any modified files to carry prominent notices
// stating that You changed the files; and

// (c) You must retain, in the Source form of any Derivative Works
// that You distribute, all copyright, patent, trademark, and
// attribution notices from the Source form of the Work,
// excluding those notices that do not pertain to any part of
// the Derivative Works; and

// (d) If the Work includes a "NOTICE" text file as part of its
// distribution, then any Derivative Works that You distribute must
// include a readable copy of the attribution notices contained
// within such NOTICE file, excluding those notices that do not
// pertain to any part of the Derivative Works, in at least one
// of the following places: within a NOTICE text file distributed
// as part of the Derivative Works; within the Source form or
// documentation, if provided along with the Derivative Works; or,
// within a display generated by the Derivative Works, if and
// wherever such third-party notices normally appear. The contents
// of the NOTICE file are for informational purposes only and
// do not modify the License. You may add Your own attribution
// notices within Derivative Works that You distribute, alongside
// or as an addendum to the NOTICE text from the Work, provided
// that such additional attribution notices cannot be construed
// as modifying the License.

// You may add Your own copyright statement to Your modifications and
// may provide additional or different license terms and conditions
// for use, reproduction, or distribution of Your modifications, or
// for any such Derivative Works as a whole, provided Your use,
// reproduction, and distribution of the Work otherwise complies with
// the conditions stated in this License.

// 5. Submission of Contributions. Unless You explicitly state otherwise,
// any Contribution intentionally submitted for inclusion in the Work
// by You to the Licensor shall be under the terms and conditions of
// this License, without any additional terms or conditions.
// Notwithstanding the above, nothing herein shall supersede or modify
// the terms of any separate license agreement you may have executed
// with Licensor regarding such Contributions.

// 6. Trademarks. This License does not grant permission to use the trade
// names, trademarks, service marks, or product names of the Licensor,
// except as required for reasonable and customary use in describing the
// origin of the Work and reproducing the content of the NOTICE file.

// 7. Disclaimer of Warranty. Unless required by applicable law or
// agreed to in writing, Licensor provides the Work (and each
// Contributor provides its Contributions) on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
// implied, including, without limitation, any warranties or conditions
// of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
// PARTICULAR PURPOSE. You are solely responsible for determining the
// appropriateness of using or redistributing the Work and assume any
// risks associated with Your exercise of permissions under this License.

// 8. Limitation of Liability. In no event and under no legal theory,
// whether in tort (including negligence), contract, or otherwise,
// unless required by applicable law (such as deliberate and grossly
// negligent acts) or agreed to in writing, shall any Contributor be
// liable to You for damages, including any direct, indirect, special,
// incidental, or consequential damages of any character arising as a
// result of this License or out of the use or inability to use the
// Work (including but not limited to damages for loss of goodwill,
// work stoppage, computer failure or malfunction, or any and all
// other commercial damages or losses), even if such Contributor
// has been advised of the possibility of such damages.

// 9. Accepting Warranty or Additional Liability. While redistributing
// the Work or Derivative Works thereof, You may choose to offer,
// and charge a fee for, acceptance of support, warranty, indemnity,
// or other liability obligations and/or rights consistent with this
// License. However, in accepting such obligations, You may act only
// on Your own behalf and on Your sole responsibility, not on behalf
// of any other Contributor, and only if You agree to indemnify,
// defend, and hold each Contributor harmless for any liability
// incurred by, or claims asserted against, such Contributor by reason
// of your accepting any such warranty or additional liability.

// END OF TERMS AND CONDITIONS

// APPENDIX: How to apply the Apache License to your work.

// To apply the Apache License to your work, attach the following
// boilerplate notice, with the fields enclosed by brackets "{}"
// replaced with your own identifying information. (Don't include
// the brackets!)  The text should be enclosed in the appropriate
// comment syntax for the file format. We also recommend that a
// file or class name and description of purpose be included on the
// same "printed page" as the copyright notice for easier
// identification within third-party archives.

// Copyright {yyyy} {name of copyright owner}

// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at

// http://www.apache.org/licenses/LICENSE-2.0

// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

import TaskStorage from './taskStorage.js';
import LabelStorage from './labelStorage.js';
import KanbanStorage from './kanbanStorage.js';
import '../libraries/jkanban.min.js';
import { event, nodeName } from 'jquery';

const taskWrapper = document.getElementById("taskWrapper");
const taskAll = document.getElementById("taskgrid");
const form = document.getElementById("taskForm");
const tasks = document.getElementById("taskList");
const labelDropdown = document.getElementById('taskLabelDropdown');

var taskDescription = document.getElementById("td");
var dueDate = document.getElementById("dd");
var completionTime = document.getElementById("ct");
var priorityRating = document.getElementById("pr");
var estimatedTime = document.getElementById("et");
var labelName = document.getElementById("newLabelInput");
var labelColour = document.getElementById("labelColourInput");

Date.prototype.toDateInputValue = (function () {
  var local = new Date(this);
  local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
  return local.toJSON().slice(0, 10);
});

const addBtn = document.getElementById('addBtn');
const addPage = document.getElementById('addTask');
const uploadBtn = document.getElementById('uploadBtn');
const closeBtn = document.getElementById('closeAdd');
const taskBtn = document.querySelector('.task_btn');
const kanban = document.getElementById('kanban');

let taskOpen = false;
// Event Listener: Task List Open
taskBtn.addEventListener('click', () => {
  if (!taskOpen) {
    taskBtn.classList.add('open');
    taskAll.classList.add('open');
    taskWrapper.classList.add('open');
    kanban.classList.add('open');
    taskOpen = true;
  } else {
    taskBtn.classList.remove('open');
    taskAll.classList.remove('open');
    taskWrapper.classList.remove('open');
    kanban.classList.remove('open');
    taskOpen = false;
  }
})

$("#myKanban").click(function(event) {
  // Disable closing tasklist when the following elements were clicked
  if($(event.target).is('.kanbanItemBtn, .kanban-title-board, .kanban-board-header') || $(event.target).is("i, input")){
  } else if (taskOpen) {
    taskBtn.classList.remove('open');
    taskAll.classList.remove('open');
    taskWrapper.classList.remove('open');
    kanban.classList.remove('open');
    taskOpen = false;
  }
})

// close Add Tasks when Task Grid is clicked
taskAll.onclick = function () {
  if (addOpen) {
    addPage.classList.remove('open');
    addBtn.classList.remove('open');
    uploadBtn.classList.remove('open');
    addOpen = false;
  }
}


let addOpen = false;
// Event Listener: Open Add Page
addBtn.addEventListener('click', () => {
  if (!addOpen) {
    addPage.classList.add('open');
    addBtn.classList.add('open');
    uploadBtn.classList.add('open');
    addOpen = true;
  }
})

// Event Listener: Close Add Page
closeBtn.addEventListener('click', () => {
  if (addOpen) {
    addPage.classList.remove('open');
    addBtn.classList.remove('open');
    uploadBtn.classList.remove('open');
    addOpen = false;
  }
})

// Event Listener: Upload Tasks
uploadBtn.addEventListener("click", function (event) {
  // console.log(addOpen); 
  if (addOpen) {
    // event.preventDefault();
    let td = taskDescription.value;
    let dd = String(dueDate.value);
    let ct = String(completionTime.value);
    let pr = priorityRating.options[priorityRating.selectedIndex].value;
    let prIndex = priorityRating.options[priorityRating.selectedIndex].index;
    let et = estimatedTime.value;
    let cs = false;
    let label = {
      name: labelName.value,
      colour: labelColour.value
    }

    addTask(td, dd, ct, pr, prIndex, et, cs, label);
  }
})

// Task Storage
const taskStorage = new TaskStorage();
const taskList = taskStorage.tasks;

// Label Storage
const labelStorage = new LabelStorage();
const labelList = labelStorage.labels;

// Kanban Storage
const kanbanStorage = new KanbanStorage();
const kanbanColumns = kanbanStorage.boards;

$(document).ready(function () {
  taskList.forEach((element) => {
    showTask(element);
  })
  updateLabelDropdown();
  editableBoardTitle();
  resizeBoards();
});

// Updates the Empty Status for Task List and Task Label Dropdown
function updateEmpty() {
  if (taskList.length > 0) {
    document.getElementById('emptyTaskList').style.display = 'none';
  } else {
    document.getElementById('emptyTaskList').style.display = 'block';
  }

  if (labelList.length > 0) {
    document.getElementById('noLabels').style.display = "none";
  } else {
    document.getElementById('noLabels').style.display = "block";
  }
}

// Updates the label dropdown in HTML via current Label Storage
function updateLabelDropdown() {
  $('.dropdown-labels').remove();
  labelList.forEach((element) => {
    let labelSelect = document.createElement('li');
    labelSelect.classList.add("dropdown-labels");
    let buttonGroup = document.createElement('div');
    buttonGroup.classList.add("btn-group");
    buttonGroup.setAttribute("role", "group");
    buttonGroup.setAttribute("aria-label", "Label Buttons Group");
    // buttonGroup.style.border = "1px solid black";

    let labelBtn = document.createElement('button');
    labelBtn.classList.add('btn', 'btn-outline-secondary');
    // labelBtn.classList.add('nav_btn');
    labelBtn.classList.add('dropdown-item');
    labelBtn.classList.add('label_btns');
    labelBtn.innerHTML = element.name.toString();
    labelBtn.style.color = element.colour;
    labelBtn.style.fontWeight = "550";

    labelBtn.addEventListener('click', function (e) {
      e.preventDefault();
      let labelTitle = labelBtn.innerHTML;
      document.getElementById("newLabelInput").value = labelTitle.toString();
      let colour = labelStorage.getColour(labelTitle.toString());
      document.getElementById("labelColourInput").value = colour;
    })

    // add Delete Button for Labels
    let delButton = document.createElement("button");
    delButton.setAttribute("type", "button");
    delButton.classList.add("btn", "btn-outline-danger", "btn-sm", "label-deleteBtn")
    delButton.innerHTML = "<i class='fas fa-trash-alt'></i>";
    delButton.style.border = "none";
    // delButton.classList.add('deleteBtn');

    delButton.addEventListener("click", function (event) {
      // event.preventDefault();
      if (confirm('Are you sure you want to delete this label from task labels?')) {
        labelStorage.delete(element);
        labelSelect.remove();
      }
    })
    buttonGroup.appendChild(labelBtn);
    buttonGroup.appendChild(delButton);
    labelSelect.appendChild(buttonGroup);
    labelDropdown.appendChild(labelSelect);
  })
  updateEmpty();
}

// Add task in the local storage & call showTask()
function addTask(taskDescription, dueDate, completionTime, priorityRating, priorityRatingIndex, estimatedTime, completionStatus, label) {
  let task = {
    id: Date.now(),
    taskDescription,
    dueDate,
    completionTime,
    priorityRating,
    priorityRatingIndex,
    estimatedTime,
    completionStatus,
    label
  }

  // Alert if there is no user input for the task name:
  if (document.forms["taskForm"]["taskName"].value == "") {
    alert("Task Description must be filled out");
  }

  else {
    let key = (task.taskDescription).toString();
    // If created task doesn't exits (task name):
    if (taskStorage.getIndexByName(key) === -1) {
      // console.log(task.label)
      // If there is no label input, empty label for the task
      if (task.label.name == "") {
        task.label = null;
        taskStorage.create(task, key);
        showTask(task);
        closeBtn.click();
      } else if (labelStorage.labelNameExists(task.label)) {
        let colour = labelStorage.getColour(task.label.name);
        task.label.colour = colour;
        // Add a task in Task Storage 
        taskStorage.create(task, key);
        showTask(task);
        closeBtn.click();

      } else if (labelStorage.labelColourExists(task.label)) {
        alert("Label colour already exists");
      } else {
        labelStorage.create(task.label, task.label.name, task.label.colour);
        // Add a task in Task Storage 
        taskStorage.create(task, key);
        showTask(task);
        closeBtn.click();
      }
    } else {
      alert("Task " + key + " is already exists in the list")
    }
  }
}

// ShowTask: showing task visually in regards with its properties
function showTask(task) {
  updateLabelDropdown();

  let item = document.createElement("div");
  item.setAttribute('class', 'card');
  item.classList.add('task_item');
  item.setAttribute('data-id', task.id);
  item.setAttribute('data-taskname', task.taskDescription);

  item.setAttribute("data-kanban", "");

  let item_body = document.createElement('div');
  item_body.setAttribute('class', 'card-body');

  let item_top = document.createElement("div");
  item_top.classList.add('item_top');

  let item_title = document.createElement("h5");
  item_title.setAttribute('class', 'card-title');
  item_title.appendChild(document.createTextNode(task.taskDescription));

  // Create a checkbox that moves the task to the Kanban "Done" column
  let doneBtn = document.createElement('button');
  doneBtn.innerHTML = "<i class='fas fa-check fa-xs'></i>"
  doneBtn.setAttribute('type', 'button');
  doneBtn.classList.add('btn');
  doneBtn.classList.add('btn-outline-success');
  doneBtn.classList.add('checkBtn');
  doneBtn.addEventListener('click', () => {
    let element = {
      id: task.taskDescription,
      title: task.taskDescription + "<button type='button' class='btn btn-outline-danger btn-sm kanbanItemBtn' data-target=" + task.taskDescription + "><i class='fas fa-trash-alt'></i></button>",
      currentBoard: "done"
    }
    kanbanStorage.addItem(element, "done");
    kanbanBoard.addElement("done", element);
    
    // let itemKanban = {
    //   name: text,
    //   color: color
    // }
    // $(item).attr("data-kanban", JSON.stringify(itemKanban));

    let board = kanbanColumns[kanbanStorage.getColumnIndex(element.currentBoard)];  
    let color = board.color;
    let el = $(`.kanban-item[data-eid="${task.taskDescription}"]`)[0];

    el.style.backgroundColor = color;
    $(el).effect("slide", {direction: "left"}, 400)
          .animate({
            backgroundColor: "white"
          }, {duration: 1000, queue: false});
    
    itemMoved($(`.task_item[data-taskname="${element.id}"]`)[0], element, board);
  })


  let left_body = document.createElement("div");
  let right_body = document.createElement("div");
  left_body.classList.add("task-left");
  right_body.classList.add("task-right");

  item_top.appendChild(doneBtn);
  item_top.appendChild(item_title);
  item_body.appendChild(item_top);

  // Task label shown when theres an input value
  if (task.hasOwnProperty('label') && task['label']) {
    if (task.label !== null) {
      let labelName = task.label.name;
      let labelNameString = labelName.toString();
      let item_tag = document.createElement('span');
      item_tag.classList.add("badge", "task-labels");
      item_tag.setAttribute('id', labelNameString);
      item_tag.appendChild(document.createTextNode(labelName));
      item_tag.style.backgroundColor = task.label.colour;
      item_top.appendChild(item_tag);
      // item_top.appendChild(item_tag);
    }
  }

  // let kanbanTag = document.createElement('span');
  // kanbanTag.classList.add("badge", "kanban-labels");
  

  // Due date shown when theres an input value
  if (task.hasOwnProperty('dueDate') && task['dueDate']) {
    let dd = document.createElement("div");
    dd.setAttribute('class', 'task_details');
    dd.innerHTML = '<i class="far fa-calendar"></i>';

    let item_dd = document.createElement("p");
    item_dd.setAttribute('class', 'card-text');
    item_dd.appendChild(document.createTextNode(task.dueDate));
    dd.appendChild(item_dd);
    left_body.appendChild(dd);
  }

  // Priority rating shown when theres an input value
  if (task.hasOwnProperty('priorityRating') && task['priorityRating']) {
    let pr = document.createElement("div");
    pr.setAttribute('class', 'task_details');

    // add classes corresponding to the priority rating input
    if (task['priorityRating'] == "Low") {
      pr.classList.add("low_pr");
    }
    else if (task['priorityRating'] == "Medium") {
      pr.classList.add("medium_pr");
    }
    else if (task['priorityRating'] == "High") {
      pr.classList.add("high_pr");
    }

    pr.innerHTML = '<i class="fas fa-flag"></i>';

    let item_pr = document.createElement("p");
    item_pr.setAttribute('class', 'card-text');
    item_pr.appendChild(document.createTextNode(task.priorityRating));
    pr.appendChild(item_pr);
    left_body.appendChild(pr);
  }

  // Estimated time shown when theres an input value
  if (task.hasOwnProperty('estimatedTime') && task['estimatedTime']) {
    let et = document.createElement("div");
    et.setAttribute('class', 'task_details');
    et.innerHTML = '<i class="far fa-clock"></i>';

    let item_et = document.createElement("p");

    item_et.setAttribute('class', 'card-text');
    item_et.appendChild(document.createTextNode(task.estimatedTime + " hours"));
    et.appendChild(item_et);
    left_body.appendChild(et);
  }

  item_body.appendChild(left_body);

  let buttons = document.createElement("span");
  buttons.classList.add("btn-group");
  buttons.classList.add("btn-group-sm");
  buttons.classList.add("task_buttons");
  buttons.setAttribute("role", "group");

  // "Move to Kanban" Button for each tasks
  let moveButton = document.createElement("button");

  moveButton.innerHTML = "<i class='fas fa-columns'></i>";
  moveButton.setAttribute('class', "btn btn-outline-primary btn-xs");
  moveButton.classList.add("moveBtn");

  moveButton.addEventListener("click", function (event) {
    let boardId = $(`.kanban-board[data-order="1"]`).attr("data-id");

    let element = {
      id: task.taskDescription,
      title: task.taskDescription + "<button type='button' class='btn btn-outline-danger btn-sm kanbanItemBtn' data-target=" + task.taskDescription + "><i class='fas fa-trash-alt'></i></button>",
      currentBoard: boardId
    }

    kanbanStorage.addItem(element, boardId);
    kanbanBoard.addElement(boardId, element);

    let board = kanbanColumns[kanbanStorage.getColumnIndex(element.currentBoard)];  
    let color = board.color;
    let el = $(`.kanban-item[data-eid="${task.taskDescription}"]`)[0];

    el.style.backgroundColor = color;
    $(el).effect("slide", {direction: "left"}, 400)
          .animate({
            backgroundColor: "white"
          }, {duration: 1000, queue: false});
    
    itemMoved($(`.task_item[data-taskname="${element.id}"]`)[0], element, board);
  })

  // let kanbanSelect = document.createElement("select");
  // kanbanSelect.classList.add("form-select", "kanban-select", "form-select-sm");
  // kanbanSelect.setAttribute("data-item", task.taskDescription);

  // let defaultOption = document.createElement("option");
  // defaultOption.innerHTML = "Select the Board:";
  // defaultOption.classList.add("kanban-none", "kanban-options");
  // defaultOption.setAttribute("value", "");
  // kanbanSelect.appendChild(defaultOption);


  // Delete Button for each tasks
  let delButton = document.createElement("button");
  delButton.innerHTML = "<i class='fas fa-trash-alt'></i></button>";

  delButton.setAttribute('class', "btn btn-outline-danger btn-xs");
  delButton.classList.add('deleteBtn');
  // delButton.setAttribute("data-bs-toggle", "tooltip");
  // delButton.setAttribute("data-bs-placement", "top");
  // delButton.setAttribute("title", "Delete Task")
  // $('[data-toggle="tooltip"]').tooltip();

  delButton.addEventListener("click", function (event) {
    // event.preventDefault();
    if (confirm('Are you sure you want to delete this task from task list?')) {
      taskStorage.delete(task.taskDescription.toString());
      item.remove();
      updateEmpty();
    }
  })

  // Kanban Board Dropdown Button (for mobile)
  let kanbanDropdown = document.createElement("div");
  kanbanDropdown.classList.add("btn-group");
  let dropdownBtn = document.createElement("button");
  dropdownBtn.classList.add("btn", "dropdown-toggle", "kanban-select", "btn-sm");
  dropdownBtn.setAttribute("type", "button");
  dropdownBtn.setAttribute("data-bs-toggle", "dropdown");
  dropdownBtn.setAttribute("data-item", task.taskDescription);
  dropdownBtn.innerHTML = "Move Item";
  let dropdownList = document.createElement("ul");
  dropdownList.classList.add("dropdown-menu");
  dropdownList.classList.add("kanban-dropdown-list");
  dropdownList.setAttribute("data-item", task.taskDescription);
  // let defaultOption = document.createElement("li");
  // let defaultOptionA = document.createElement("a");
  // defaultOptionA.classList.add("dropdown-item");
  // defaultOptionA.innerHTML = "No Board Selected";

  // defaultOption.appendChild(defaultOptionA);
  // dropdownList.appendChild(defaultOption);
  kanbanDropdown.appendChild(dropdownBtn);
  kanbanDropdown.appendChild(dropdownList);

  // $(".kanban-select").on("focus", function() {
  //   var previous = $(this).children(".kanban-options:selected");
  //   console.log(previous);

  //   $(".kanban-options").change((event) => {
  //     previous.setAttribute("selected", "false");
  //     console.log(event.target.value);
  //   })
  // })


  buttons.appendChild(moveButton);
  buttons.appendChild(delButton);
  right_body.appendChild(kanbanDropdown);
  right_body.appendChild(buttons);
  item_body.appendChild(right_body);  
  // item_body.appendChild(kanbanDropdown);
  item.appendChild(item_body);
  // item.appendChild(buttons);
  tasks.appendChild(item);

  form.reset();
}


// Helper Compare functions for sorting 
function compareDateCreated(a,b) {

  return a.id - b.id;
}

function compareDueDate(a, b) {
  // equal items sort equally
  if (a.dueDate === b.dueDate) {
    return 0;
  }
  // nulls sort after anything else
  else if (a.dueDate === "") {
    return 1;
  }
  else if (b.dueDate === "") {
    return -1;
  } else { 
      return a.dueDate < b.dueDate ? -1 : 1;
  }
}

function comparePriority(a, b) {
  if (a.priorityRatingIndex === b.priorityRatingIndex) {
    return 0;
  }
  // nulls sort after anything else
  else if (a.priorityRatingIndex == "") {
    return 1;
  }
  else if (b.priorityRatingIndex == "") {
    return -1;
  } else { 
    return parseInt(a.priorityRatingIndex) < parseInt(b.priorityRatingIndex) ? 1 : -1;
  }
}

function compareEstimatedTime(a, b) {
  // if (a.estimatedTime < b.estimatedTime) {
  //   return -1;
  // } else if (a.estimatedTime > b.estimatedTime) {
  //   return 1;
  // } else {
  //   return 0;
  // }
  if (a.estimatedTime === b.estimatedTime) {
    return 0;
  }
  // nulls sort after anything else
  else if (a.estimatedTime == "") {
    return 1;
  }
  else if (b.estimatedTime == "") {
    return -1;
  } else { 
    return parseInt(a.estimatedTime) < parseInt(b.estimatedTime) ? -1 : 1;
  }
}


// Add task by hitting "Enter" on keyboard
$(".addTaskInputs").keypress(function(e) {
  if (e.which == 13) {
    e.preventDefault();
    // alert("enter clicked");
    $("#uploadBtn").click();
  }
})
// Add board by hitting "Enter" on keyboard
$(".kanbanBoard-inputs").keypress(function(e) {
  if (e.which == 13) {
    e.preventDefault();
    $("#addBoardBtn").click();
  }
})

// Sorting items in taskList(storage) by their properties and re-showing them via showTask() function 
$(".sortDateCreated").click(function(event) {
  taskList.sort(compareDateCreated);
  console.log(taskList);
  tasks.innerHTML = "<p id='emptyTaskList'>You haven\'t added any tasks yet.</p>";
  taskList.forEach((task) => {
    showTask(task);
  })
  $("#closeAdd").click();
})

$(".sortDueDate").click(function(event) {
  taskList.sort(compareDueDate);
  console.log(taskList);
  tasks.innerHTML = "<p id='emptyTaskList'>You haven\'t added any tasks yet.</p>";
  taskList.forEach((task) => {
    showTask(task);
  })
  $("#closeAdd").click();
})

$(".sortPriorityRating").click(function(event) {
  taskList.sort(comparePriority);
  console.log(taskList);
  tasks.innerHTML = "<p id='emptyTaskList'>You haven\'t added any tasks yet.</p>";
  taskList.forEach((task) => {
    showTask(task);
  })
  $("#closeAdd").click();
})

$(".sortEstimatedTime").click(function(event) {
  taskList.sort(compareEstimatedTime);
  console.log(taskList);
  tasks.innerHTML = "<p id='emptyTaskList'>You haven\'t added any tasks yet.</p>";
  taskList.forEach((task) => {
    showTask(task);
  })
  $("#closeAdd").click();
})

// Updates the Kanban Select (mobile) dropdown button
function updateKanbanSelect() {
  $(".task_item").each(function(i,obj) {
    let id = $(obj).attr("data-taskname");
    let kanbanButton = $(obj).find(".kanban-select")[0];

    let htmlItem = $(`.task_item[data-taskname="${id}"]`)[0];
    let itemObject = kanbanStorage.getItemObject(id);

    kanbanColumns.forEach((board) => {
      let li = document.createElement("li");
      let newOption = document.createElement("a");
      newOption.innerHTML = board.title;
      newOption.setAttribute("data-target", board.id);
      newOption.classList.add("kanban-" + board.id, "kanban-options", "dropdown-item");
      newOption.style.color = "white";
      li.appendChild(newOption);
      li.style.backgroundColor = board.color;
    
      $(newOption).click(function() {
        kanbanButton.innerHTML = board.title; 
        kanbanButton.style.backgroundColor = board.color;
        let boardId = $(newOption).attr("data-target")
        kanbanStorage.removeItemAll(id);
        kanbanBoard.removeElement(id);
        let item = {
          id: $(obj).attr("data-taskname"),
          currentBoard: boardId,
          title: id + `<button type='button' class='btn btn-outline-danger btn-sm kanbanItemBtn' data-target="${id}"><i class='fas fa-trash-alt'></i></button>`
        }
        kanbanStorage.addItem(item, boardId);
        kanbanBoard.addElement(boardId, item);
        itemMoved(htmlItem, itemObject, board);
      })

      $(obj).find(".kanban-dropdown-list").append(li);
    })
  })
}

// Allowing editing on the board titles
function editableBoardTitle() {
  document.querySelectorAll('.kanban-title-board').forEach((boardName) => {
    boardName.setAttribute("contenteditable", "true");
    boardName.addEventListener("click", () => {
      let name = boardName.innerHTML.toString();
      // console.log(name);
    })
  })
}

// Resizing board's width
function resizeBoards() {
  document.querySelectorAll(".kanban-board").forEach((board) => {
    let boardNum = kanbanBoard.boardContainer.length;
    let boardWidth = (100 / (boardNum)) - 2;
    board.style.width = boardWidth.toString() + "%";
  })
}

// kanban board using jKanban and custom callback functions for actions
var kanbanBoard = new jKanban({
  element: '#myKanban',                                          // selector of the kanban container
  // gutter           : '15px',                                  // gutter of the board
  // widthBoard       : '250px',                                 // width of the board
  responsivePercentage: true,                                    // if it is true I use percentage in the width of the boards and it is not necessary gutter and widthBoard
  dragItems: true,                                               // if false, all items are not draggable
  boards: [],                                                    // json of boards
  dragBoards: true,                                              // the boards are draggable, if false only item can be dragged
  itemAddOptions: {
    enabled: false,                                              // add a button to board for easy item creation
    content: '+',                                                // text or html content of the board button   
    class: 'kanban-title-button btn btn-default btn-xs',         // default class of the button
    footer: false                                                // position the button on footer
  },
  itemHandleOptions: {
    enabled: false,                                               // if board item handle is enabled or not
    handleClass: "item_handle",                                   // css class for your custom item handle
    customCssHandler: "drag_handler",                             // when customHandler is undefined, jKanban will use this property to set main handler class
    customCssIconHandler: "drag_handler_icon",                    // when customHandler is undefined, jKanban will use this property to set main icon handler class. If you want, you can use font icon libraries here
    customHandler: "<span class='item_handle'>+</span> %title% "  // your entirely customized handler. Use %title% to position item title 
  },
  click: function (el) { },                                       
  context: function (el, event) { },                              
  dragEl: function (el, source) { 
    let color = source.previousElementSibling.style.backgroundColor;
  },                                                              
  dragendEl: function (el) { },                                  
  dropEl: function (el, target, source, sibling) { 
    // save and move the item when its dragged in kanbanBoard
    let itemId = $(el).attr("data-eid");
    let targetId = target.parentElement.dataset.id;
    let sourceId = source.parentElement.dataset.id;

    let item = kanbanStorage.getItemObject(itemId);

    item.currentBoard = targetId;

    kanbanStorage.removeItem(itemId, sourceId);
    kanbanStorage.addItem(item, targetId);

    let board = kanbanStorage.getBoardObject(targetId);
    let boardColor = board.color;

    // animation for drop
    $(el).effect("slide", {direction: "left"}, 400)
          .animate({
            backgroundColor: boardColor,
          }, {duration: 400, queue: false});

    $(el).animate({
    backgroundColor: "white"
    }, {duration: 800, queue: true});

    let htmlItem = $(`.task_item[data-taskname="${item.id}"`)[0];

    itemMoved(htmlItem,item, board);
  },                                 
  dragBoard: function (el, source) { 
  },                        
  dragendBoard: function (el) { 
    $(".kanban-board").each((i, obj) => {
      let boardId = $(obj).attr("data-id");
      let boardOrder = $(obj).attr("data-order");
      kanbanStorage.updateBoardOrder(boardId,boardOrder);
    })
    kanbanStorage.sortBoards();
  },                                                              
  buttonClick: function (el, boardId) { }                        
});

// Default columns for Kanban Board
var columns = [
  { id: 'toDo', title: "To Do", item: [], color: "#178bff", order: 1},
  { id: 'inProgress', title: "In Progress", item: [], color: "#ffc31e", order: 2},
  { id: 'done', title: "Done", item: [], color: "#3dd66b", order: 3}
];

// add boards from kanbanStorage when document loads
$(document).ready(function () {
  for (let i = 0; i < kanbanColumns.length; i++) {
    let board = kanbanColumns[i];

    kanbanBoard.addBoards([board]);

    for (let j=0;j<board.items.length;j++) {
      let element = board.items[j];
      kanbanBoard.addElement(board.id, element);
      itemMoved($(`.task_item[data-taskname="${element.id}"]`)[0], element, board);

      let kanbanSelect = $(`.task_item[data-taskname="${element.id}"]`).find(".kanban-select")[0];
      $(kanbanSelect).html(board.title);
      kanbanSelect.style.backgroundColor = board.color;
    }

    resizeBoards();
    let boardHeader = document.querySelector(".kanban-board[data-id='" + board.id + "'] > .kanban-board-header");
    boardHeader.style.backgroundColor = board.color;

    let deleteBtn = document.createElement("button");
    deleteBtn.setAttribute("type", "button");
    deleteBtn.classList.add("btn", "btn-outline-danger", "btn-sm", "boardDeleteBtn");
    deleteBtn.innerHTML = "<i class='fas fa-trash-alt'></i>";

    deleteBtn.addEventListener("click", () => {
      kanbanStorage.removeBoard(board.id);
      kanbanBoard.removeBoard(board.id);
      let boards = kanbanBoard.boardContainer;
      let pos = boards.indexOf(board);
      boards.splice(pos, 1);
      resizeBoards();
    })
    boardHeader.appendChild(deleteBtn);
    editableBoardTitle();
  }
  updateKanbanSelect();
})

// Helper function for styling when item in kanban board is moved
function itemMoved(htmlItem, itemObject, board) {
  let moveButton = $(htmlItem).find(".moveBtn")[0];
  let doneButton = $(htmlItem).find(".checkBtn")[0];
  let taskDelBtn = $(htmlItem).find(".deleteBtn")[0];
  moveButton.setAttribute("disabled", "true");
  doneButton.setAttribute("disabled", "true");

  let item_title = $(htmlItem).find(".card-title")[0];

  if(board.id == "done") {
    item_title.style.textDecoration = "line-through";
    htmlItem.style.backgroundColor = "#c2c2c2";
    htmlItem.style.border = "none";
    taskDelBtn.classList.add("btn-danger");
    taskDelBtn.classList.remove("btn-outline-danger");
  } else {
    htmlItem.style.border = `3px solid ${board.color}`;
    item_title.style.textDecoration = "none";
    htmlItem.style.backgroundColor = "white";
    taskDelBtn.classList.remove("btn-danger");
    taskDelBtn.classList.add("btn-outline-danger");
  }

  $(`button[data-target="${itemObject.id}"]`).click(function(event) {
    kanbanStorage.removeItem(itemObject.id, itemObject.currentBoard);
    kanbanBoard.removeElement(itemObject.id);
    moveButton.removeAttribute("disabled");
    doneButton.removeAttribute("disabled");

    item_title.style.textDecoration = "none";
    htmlItem.style.backgroundColor = "whitesmoke";
    htmlItem.style.border = "none";
    taskDelBtn.classList.remove("btn-danger");
    taskDelBtn.classList.add("btn-outline-danger");

    $(htmlItem).attr("data-kanban", "");
  })
}



const addBoardWrapperBtn = document.getElementById("addBoardWrapperBtn");
const addBoardBtn = document.getElementById("addBoardBtn");
const boardNameInput = document.getElementById("boardNameInput");
const boardColorInput = document.getElementById("boardColorInput");

// Event Listenter for adding a new board in Kanban Board
addBoardBtn.addEventListener("click", () => {
  if (boardNameInput.value == "") {
    alert("Board title required");
  } else {
    let boardTitle = boardNameInput.value.toString()
    let board = {
      id: boardTitle,
      title: boardTitle,
      items: [],
      color: boardColorInput.value,
      order: kanbanColumns.length + 1
    }

    kanbanStorage.addBoard(board);
    kanbanBoard.addBoards([board]);
    resizeBoards();

    let boardHeader = document.querySelector(".kanban-board[data-id='" + board.id + "'] > .kanban-board-header");
    boardHeader.style.backgroundColor = boardColorInput.value;

    let deleteBtn = document.createElement("button");
    deleteBtn.setAttribute("type", "button");
    deleteBtn.classList.add("btn", "btn-outline-danger", "btn-sm", "boardDeleteBtn");
    deleteBtn.innerHTML = "<i class='fas fa-trash-alt'></i>";

    deleteBtn.addEventListener("click", () => {
      kanbanStorage.removeBoard(board.id);
      kanbanBoard.removeBoard(board.id);
      let boards = kanbanBoard.boardContainer;
      let pos = boards.indexOf(board);
      boards.splice(pos, 1);
      resizeBoards();
    })

    boardHeader.appendChild(deleteBtn);
    editableBoardTitle();
    boardNameInput.value = "";
  }
})